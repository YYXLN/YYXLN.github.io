// renderer/build.js
import fs from "fs";
import path from "path";
import { fileURLToPath } from "url";
import { marked } from "marked";
import { convertMarkdownToStyledHTML } from "./renderer.js";

global.marked = marked; // expose to renderer

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const ROOT = path.resolve(__dirname, "..");
const CONCEPTS = path.join(ROOT, "concepts");

function exists(p) {
  try { fs.accessSync(p); return true; } catch { return false; }
}

function buildOne(mdPath, htmlPath, { title, quotes, shimmerTitle = true }) {
  const md = fs.readFileSync(mdPath, "utf8");
  const html = convertMarkdownToStyledHTML(md, { title, quotes, shimmerTitle });
  fs.writeFileSync(htmlPath, html);
  console.log("✅ Built", path.relative(ROOT, htmlPath));
}

// 1) Build all concepts/*.md → concepts/*.html
if (exists(CONCEPTS)) {
  for (const file of fs.readdirSync(CONCEPTS)) {
    if (file.toLowerCase().endsWith(".md")) {
      const mdPath = path.join(CONCEPTS, file);
      const out = file.replace(/\.md$/i, ".html");
      const htmlPath = path.join(CONCEPTS, out);

      buildOne(mdPath, htmlPath, {
        title: "Ashley Ye",
        quotes: [
          "“Where is the life we have lost in living? Where is the wisdom we have lost in knowledge? Where is the knowledge we have lost in information?”",
          "“Perhaps you seek too much — as a result you seek so little.”"
        ],
        shimmerTitle: true
      });
    }
  }
}

// 2) OPTIONAL: Build README.md → index.html (toggle flag)
const BUILD_README_TO_INDEX = false;
const readmePath = path.join(ROOT, "README.md");
const indexPath = path.join(ROOT, "index.html");

if (BUILD_README_TO_INDEX && exists(readmePath)) {
  buildOne(readmePath, indexPath, {
    title: "Ashley Ye",
    quotes: [
      "“Where is the life we have lost in living? Where is the wisdom we have lost in knowledge? Where is the knowledge we have lost in information?”",
      "“Perhaps you seek too much — as a result you seek so little.”"
    ],
    shimmerTitle: true
  });
}
